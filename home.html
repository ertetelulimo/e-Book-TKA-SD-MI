<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tes Akademik SD</title>
<style>
body {
  font-family: Arial,sans-serif;
  margin:0;
  padding:20px;
  background:#ff3333;
}
.card {
  max-width:1000px;
  margin:0 auto;
  padding:25px;
  border-radius:12px;
  background:#ff1a1a;
  color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);
}
input, select, button {
  padding:8px;
  margin:4px 0;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:1rem;
}
button {
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}
button:hover { opacity:0.85; }
.hidden { display:none; }

.option-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-bottom:15px;
}

/* üîò Opsi jawaban: teks hitam, latar putih */
.option {
  padding:10px;
  border:2px solid #ccc;
  border-radius:8px;
  background:#fff;
  color:#000;
  cursor:pointer;
  font-weight:bold;
}
.option.selected {
  background:#06d6a0;
  border-color:#0077b6;
  color:#000;
}

/* üåü Soal & pembahasan putih */
#soalBox,
#hasilTes {
  color:white;
}
#soalContainer {
  color:white;
}
.pembahasan {
  color:white;
  background:rgba(255,255,255,0.1);
  border-left:4px solid #06d6a0;
  padding:8px;
  border-radius:6px;
  margin:5px 0;
}

/* Status benar/salah */
.statusJawaban {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:3px 8px;
  border-radius:4px;
  font-weight:bold;
}
.statusJawaban.benar { background:#06d6a0; color:#000; }
.statusJawaban.salah {
  background:#fff;
  color:#ff0000;
  border:1px solid #ff0000;
}
.statusJawaban.salah::before {
  content:"‚úñ";
  margin-right:5px;
  font-weight:bold;
}
.statusJawaban.benar::before {
  content:"‚úî";
  margin-right:5px;
  font-weight:bold;
}

.scoreBox {
  font-size:1.2rem;
  margin-top:20px;
  text-align:center;
  background:#000;
  color:#FFD700;
  padding:10px;
  border-radius:8px;
  font-weight:bold;
}

#timerBox {
  position:fixed;
  top:10px;
  right:15px;
  background:#000;
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  font-weight:bold;
  font-size:0.95rem;
  z-index:9999;
  display:none;
  box-shadow:0 0 8px rgba(0,0,0,0.4);
}
.ringkasanBox {
  background:#fff9c4;   /* kuning muda */
  color:#000;
  border-radius:10px;
  padding:10px;
  margin:10px 0;
  border-left:5px solid #fbc02d; /* aksen kuning lebih gelap (opsional) */
}

#btnKembali {
  background:#000;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px;
  width:100%;
  margin-bottom:8px;
  cursor:pointer;
  font-weight:bold;
}
#btnKembali:hover { opacity:0.85; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  color:#000;
  background:#fff;
  border-radius:8px;
  overflow:hidden;
}
th, td {
  border:1px solid #000;
  padding:8px;
  text-align:center;
}
th { background:#ffcc99; }

button.actionBtn {
  padding:4px 8px;
  border-radius:4px;
  cursor:pointer;
  margin:2px;
}

.status { font-weight:bold; padding:4px 6px; border-radius:4px; }
.status.menunggu { background:#fff3cd; color:#856404; }
.status.disetujui { background:#d4edda; color:#155724; }
.status.expired { background:#f8d7da; color:#721c24; }

#subPelajaran {
  padding:8px;
  font-size:1rem;
  border-radius:6px;
  border:1px solid #ccc;
  width:100%;
  max-width:400px;
  background:#00695c;
  color:#fff;
}
#subPelajaran option { background:#00695c; color:#fff; }

@media (max-width:768px) {
  #subPelajaran { font-size:0.9rem; }
  #subPelajaran option { font-size:0.9rem; }
}

#btnKirimJawaban {
  background:#0077b6;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
  cursor:pointer;
  font-weight:bold;
}
#btnKirimJawaban:hover { opacity:0.85; }

#btnMulaiTes {
  background:#00695c;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
  cursor:pointer;
  font-weight:bold;
}
#btnMulaiTes:hover { opacity:0.85; }

#btnKirimEmail {
  background-color:#00695c;
  color:#ffffff;
  border:none;
  border-radius:8px;
  padding:10px 15px;
  font-weight:bold;
  cursor:pointer;
  font-size:1rem;
  transition:0.3s;
  display:inline-flex;
  align-items:center;
}
#btnKirimEmail:hover { opacity:0.85; }
#btnKirimEmail img {
  display:inline-block;
  margin-right:6px;
}

.benar-salah-wrapper button {
  margin-right:6px;
  padding:4px 8px;
  border-radius:4px;
  cursor:pointer;
  border:1px solid #ccc;
}
.benar-salah-wrapper button.selected {
  background:#06d6a0;
  border-color:#0077b6;
  color:#000;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="card">
  <h2>üìò Tes Akademik SD</h2>
  <div id="timerBox">‚è± <span id="timerText">10:00</span></div>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="email" placeholder="Masukkan email">
    <input id="password" type="password" placeholder="Masukkan password">
    <button id="btnLogin">Masuk</button>
    <p id="msg"></p>

    <button id="btnKirimEmail">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA" style="width:18px; vertical-align:middle; margin-right:6px;">
      üì© Minta Password Akun ke Admin
    </button>
  </div>

  <!-- USER -->
  <div id="userBox" class="hidden">
    <div style="display:flex; align-items:center; gap:20px; margin-bottom:10px;">
      <h3 style="margin:0;">Halo, <span id="namaUser"></span> üëã</h3>
      <label style="display:flex; flex-direction:column; font-size:0.9rem; margin:0;">
        Nama Sekolah:
        <input type="text" id="namaSekolah" placeholder="Masukkan nama sekolah" style="width:200px; padding:4px 6px; border-radius:6px; border:1px solid #ccc;">
      </label>
    </div>
  </div>

  <div id="infoTesBox" style="display:flex; gap:20px; align-items:center; margin-bottom:10px;">
    <label>Nomor Absen:
      <input type="text" id="nomorAbsen" placeholder="Masukkan nomor absen" style="width:80px;">
    </label>
    <label>Durasi Tes (menit):
      <input type="number" id="timerInput" value="10" min="1" style="width:80px;"> ‚è±
    </label>
  </div>

  <div id="pilihPelajaranBox">
    <select id="subPelajaran">
      <option value="">-- Pilih Pelajaran --</option>
      <optgroup label="üåø Wajib">
        <option value="bahasa_indonesia_1">Bahasa Indonesia ‚Äì Latihan 1</option>
        <option value="bahasa_indonesia_2">Bahasa Indonesia ‚Äì Latihan 2</option>
        <option value="bahasa_indonesia_3">Bahasa Indonesia ‚Äì Latihan 3</option>
        <option value="matematika_1">Matematika ‚Äì Latihan 1</option>
        <option value="matematika_2">Matematika ‚Äì Latihan 2</option>
        <option value="matematika_3">Matematika ‚Äì Latihan 3</option>
      </optgroup>
      <optgroup label="üìò Pilihan">
        <option value="ipas_1">IPAS ‚Äì Latihan 1</option>
        <option value="pancasila_1">Pancasila ‚Äì Latihan 1</option>
        <option value="inggris_1">Bahasa Inggris ‚Äì Latihan 1</option>
        <option value="sbdp_1">SBdP ‚Äì Latihan 1</option>
        <option value="pjok_1">PJOK ‚Äì Latihan 1</option>
      </optgroup>
      <optgroup label="üìò Ulangan">
        <option value="bahasa_indonesia_ulangan">Bahasa Indonesia ‚Äì Ulangan</option>
        <option value="matematika_ulangan">Matematika ‚Äì Ulangan</option>
      </optgroup>
    </select>
  </div>

  <label style="display:flex;align-items:center;gap:6px;font-size:0.9rem;">
    <input type="checkbox" id="disableTimer"> Nonaktifkan durasi
  </label>

  <button id="btnMulaiTes" disabled>Mulai Tes</button>

  <div id="soalBox" class="hidden">
    <div id="soalContainer" style="color:white;"></div>
    <button id="btnKirimJawaban">Kirim Jawaban</button>
    <div id="hasilTes" class="hidden"></div>
  </div>

  <button id="btnKembali">‚¨ÖÔ∏è Kembali</button>
  <button id="btnLogoutUser">Logout</button>
</div>

<!-- ADMIN -->
<div id="adminBox" class="hidden">
  <h3>Panel Admin üßë‚Äçüíº</h3>
  <table>
    <thead>
      <tr>
        <th>Email</th><th>Status</th><th>Password</th>
        <th>Device</th><th>Tgl Verifikasi</th><th>Sisa Hari</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelAdminBody"></tbody>
  </table>
  <button id="btnLogoutAdmin">Logout</button>
</div>
</body>
</html>



<script>
// ===== SOAL =====
const SOAL = {};

// =========================
// BAHASA INDONESIA
// =========================

// Latihan 1
SOAL.bahasa_indonesia_1 = [
  {
    soal: `Sekolah akan mengadakan penyembelihan hewan kurban. 
Setiap siswa berpartisipasi dalam kegiatan tersebut.
Makna kata 'berpartisipasi' adalah...`,
    opsi: [
      "merencanakan jadwal kegiatan",
      "ikut serta dalam kegiatan",
      "mengawasi jalannya kegiatan",
      "menilai jalannya kegiatan"
    ],
    jawaban: 1,
    pembahasan: "Makna kata 'berpartisipasi' adalah ikut serta dalam kegiatan",
    ringkasanMateri: `
      <div style="font-weight:bold; color:#007bff;">Mengidentifikasi Makna Kata</div>
      Mencari makna kata adalah kegiatan untuk memahami arti kata-kata yang belum kita ketahui.
    `
  },
  {
    soal: `Apa sinonim dari kata 'cepat'?`,
    opsi: ["Lambat","Kencang","Besar","Pendek"],
    jawaban: 1,
    pembahasan: "Sinonim dari kata 'cepat' adalah 'kencang'.",
    ringkasanMateri: `
      <div style="font-weight:bold; color:#007bff;">Sinonim Kata</div>
      Sinonim adalah kata-kata yang memiliki makna sama atau hampir sama.
    `
  }
];

// Latihan 2
SOAL.bahasa_indonesia_2 = [
  {
    soal: `Sudah sejak lama masyarakat Indonesia memiliki keanekaragaman sumber pangan selain beras. Misalnya, sagu merupakan makanan pokok masyarakat Maluku dan sekitarnya. Ide pokok paragraf tersebut adalah...`,
    opsi: [
      "Sagu merupakan makanan utama bagi masyarakat Maluku.",
      "Masyarakat Indonesia memiliki keanekaragaman sumber pangan.",
      "Beras merupakan sumber pangan bagi masyarakat yang mampu.",
      "Makanan pokok bangsa Indonesia berbeda-beda tergantung pada sukunya."
    ],
    jawaban: 1,
    pembahasan: "Ide pokok paragraf tersebut adalah masyarakat Indonesia memiliki keanekaragaman sumber pangan.",
    ringkasanMateri: `
      <div style="font-weight:bold; color:#007bff;">Menentukan Ide Pokok Bacaan</div>
      Ide pokok adalah gagasan utama atau inti pembahasan dari sebuah paragraf.
    `
  }
];

// Latihan 3
SOAL.bahasa_indonesia_3 = [
  {
    soal: `Traktor adalah salah satu teknologi dalam bidang pertanian. Kegunaan traktor adalah untuk membajak sawah agar tanah menjadi lebih gembur dan mudah ditanami. Traktor membuat pekerjaan petani menjadi lebih mudah. Tentukan benar atau salah pernyataan berikut:`,
    tipe: "benar-salah-multi",
    pernyataan: [
      { text:"Traktor digunakan untuk menanam padi secara otomatis", key:"Salah" },
      { text:"Salah satu fungsi traktor adalah membajak sawah agar tanah menjadi lebih gembur", key:"Benar" },
      { text:"Sebelum ada traktor, petani menggunakan kerbau atau sapi untuk membajak sawah", key:"Benar" },
      { text:"Traktor merupakan salah satu teknologi maju dalam bidang pertanian", key:"Benar" }
    ],
    pembahasan: "Semua pernyataan benar kecuali 'Traktor digunakan untuk menanam padi secara otomatis'.",
    ringkasanMateri: `<div style="font-weight:bold; color:#007bff;">Memahami Informasi dalam Bacaan Nonfiksi</div>`
  }
];

// Ulangan
SOAL.bahasa_indonesia_ulangan = [
  {
    soal: `Bacalah teks berikut:

Budi membeli 5 buku tulis dan 3 pensil. Setiap buku tulis harganya 2 ribu rupiah, dan setiap pensil 1 ribu rupiah.  

Tentukan benar atau salah pernyataan berikut:`,
    tipe: "benar-salah-multi",
    pernyataan: [
      { text:"Total harga buku tulis adalah 10 ribu rupiah", key:"Benar", pembahasan:"Harga buku tulis 5 √ó 2 ribu = 10 ribu" },
      { text:"Total harga pensil adalah 4 ribu rupiah", key:"Salah", pembahasan:"Harga pensil 3 √ó 1 ribu = 3 ribu" },
      { text:"Total keseluruhan yang dibayar Budi adalah 13 ribu rupiah", key:"Benar", pembahasan:"Total = 10 ribu + 3 ribu = 13 ribu" },
      { text:"Harga setiap buku tulis lebih murah dari pensil", key:"Salah", pembahasan:"Buku tulis lebih mahal daripada pensil" }
    ],
    ringkasanMateri: `<div style="font-weight:bold; color:#007bff;">Menghitung Total Harga</div>`
  }
];

// =========================
// MATEMATIKA
// =========================
SOAL.matematika_1 = [
  {
    soal: "Hitung 7 + 5 = ?",
    opsi: ["10","11","12","13"],
    jawaban: 2,
    pembahasan:"7 + 5 = 12",
    ringkasanMateri:"<div><b>Penjumlahan</b></div>"
  }
];

SOAL.matematika_2 = [
  {
    soal: "Hitung 15 - 7 = ?",
    opsi:["6","7","8","9"],
    jawaban:2,
    pembahasan:"15 - 7 = 8",
    ringkasanMateri:"<div><b>Pengurangan</b></div>"
  }
];

SOAL.matematika_3 = [
  {
    soal: "Hitung 5 √ó 3 = ?",
    opsi:["15","20","10","13"],
    jawaban:0,
    pembahasan:"5 √ó 3 = 15",
    ringkasanMateri:"<div><b>Perkalian</b></div>"
  }
];

// Ulangan
SOAL.matematika_ulangan = [
  {
    soal: `Andi membeli 4 bola dan 2 raket. Harga bola 3 ribu, harga raket 10 ribu. Tentukan benar atau salah:`,
    tipe:"benar-salah-multi",
    pernyataan:[
      {text:"Total harga bola adalah 12 ribu", key:"Benar", pembahasan:"4 √ó 3 ribu = 12 ribu"},
      {text:"Total harga raket adalah 20 ribu", key:"Benar", pembahasan:"2 √ó 10 ribu = 20 ribu"},
      {text:"Total keseluruhan yang dibayar Andi adalah 25 ribu", key:"Salah", pembahasan:"Total = 12 ribu + 20 ribu = 32 ribu"},
      {text:"Harga bola lebih mahal dari raket", key:"Salah", pembahasan:"Bola 3 ribu, raket 10 ribu"}
    ],
    ringkasanMateri:`<div><b>Menghitung Total Harga</b></div>`
  }
];

// =========================
// MATA PELAJARAN LAIN (LATIHAN 1)
// =========================
SOAL.ipas_1 = [
  {soal:"Air menguap menjadi uap. Fenomena ini disebut?", opsi:["Mendidih","Evaporasi","Hujan","Es"], jawaban:1, pembahasan:"Air menguap = evaporasi", ringkasanMateri:"<div><b>Evaporasi</b></div>"}
];

SOAL.pancasila_1 = [
  {soal:"Pancasila terdiri dari berapa sila?", opsi:["3","4","5","6"], jawaban:2, pembahasan:"Pancasila ada 5 sila", ringkasanMateri:"<div><b>Pancasila</b></div>"}
];

SOAL.inggris_1 = [
  {soal:"Translate 'Hello' to Indonesian.", opsi:["Hai","Halo","Selamat pagi","Selamat malam"], jawaban:1, pembahasan:"Hello = Halo", ringkasanMateri:"<div><b>Bahasa Inggris</b></div>"}
];

SOAL.sbdp_1 = [
  {soal:"Alat musik dari bambu disebut?", opsi:["Gitar","Suling","Angklung","Drum"], jawaban:2, pembahasan:"Angklung berasal dari bambu", ringkasanMateri:"<div><b>SBdP</b></div>"}
];

SOAL.pjok_1 = [
  {soal:"Gerakan lari cepat disebut?", opsi:["Lari jarak jauh","Sprint","Jalan cepat","Loncat"], jawaban:1, pembahasan:"Lari cepat = Sprint", ringkasanMateri:"<div><b>PJOK</b></div>"}
];

// ===== ADMIN PASSWORD OTOMATIS (4 digit, deterministik) =====
function getAdminPassword() {
  const d = new Date();
  const tanggal = d.getDate();           // 1..31
  const bulan = d.getMonth() + 1;        // 1..12
  const tahun = d.getFullYear() % 100;   // dua digit (0..99)

  // SECRET: ubah jika mau variasi (ingat: siapa yang tahu SECRET bisa hitung password)
  const SECRET = 0xA3F1C9;

  // buat seed 32-bit dari tanggal/bulan/tahun + secret
  let seed = (((tanggal & 0xFF) << 16) | ((bulan & 0xFF) << 8) | (tahun & 0xFF)) ^ SECRET;
  seed = seed >>> 0;

  // xorshift32 PRNG (deterministik)
  function xorshift32(s) {
    s = s >>> 0;
    s ^= (s << 13) >>> 0;
    s ^= (s >>> 17) >>> 0;
    s ^= (s << 5) >>> 0;
    return s >>> 0;
  }

  // mix beberapa iterasi lalu peta ke 1000..9999 (selalu 4 digit)
  let s = seed;
  for (let i = 0; i < 6; i++) s = xorshift32(s);
  const num = (s % 9000) + 1000;

  return String(num).padStart(4, "0");
}

// ===== DATA VERIFIKASI =====
let VERIFIKASI = JSON.parse(localStorage.getItem("verifikasiData") || "{}");

// ===== AUTO LOGIN & MULAI TES =====
window.onload = () => {
  const savedUser = JSON.parse(localStorage.getItem("userData") || "null");
  if(savedUser && savedUser.email && savedUser.password){
    loginUser(savedUser.email, savedUser.password, true);

    const subPel = document.getElementById("subPelajaran");
    if(!subPel.value) subPel.value = "bahasa_indonesia_1";

    document.getElementById("btnMulaiTes").disabled = false;

    // Auto-start tes langsung jika mau
    // document.getElementById("btnMulaiTes").click();
  }

  document.getElementById("btnKembali").onclick = () => {
    document.getElementById("soalBox").classList.add("hidden");
    document.getElementById("hasilTes").classList.add("hidden");
    document.getElementById("pilihPelajaranBox").classList.remove("hidden");
    stopTimer();
  };
};

// ===== LOGIN =====
document.getElementById("btnLogin").onclick = () => {
  const email = document.getElementById("email").value.trim().toLowerCase();
  const pass = document.getElementById("password").value.trim();
  const msg = document.getElementById("msg"); 
  msg.textContent = "";

  if (!email || !pass) {
    msg.textContent = "‚ùå Isi email dan password terlebih dahulu.";
    return;
  }

  // === ADMIN LOGIN ===
  if (email === "admin@sd.com") {
    const todayPass = getAdminPassword();
    if (pass === todayPass) {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("adminBox").classList.remove("hidden");
      tampilAdmin();
      alert("‚úÖ Login Admin Berhasil");
    } else {
      msg.textContent = "‚ùå Password admin salah.";
    }
    return;
  }

  // === CEK VERIFIKASI USER ===
  const data = VERIFIKASI[email];
  if (!data) {
    msg.textContent = "‚ùå Akun belum terdaftar. Minta password ke admin dulu.";
    return;
  }

  if (data.status !== "Disetujui") {
    msg.textContent = "‚ùå Akun belum disetujui oleh admin.";
    return;
  }

  if (!data.password) {
    msg.textContent = "‚ùå Password belum diatur oleh admin.";
    return;
  }

  if (data.password !== pass) {
    msg.textContent = "‚ùå Password salah.";
    return;
  }

  // === SEMUA CEK LULUS ===
  loginUser(email, pass, false);
};

// ===== LOGIN USER =====
function loginUser(email, pass, isAuto=false){
  if(!VERIFIKASI[email]) VERIFIKASI[email]={devices:[]};
  const d = VERIFIKASI[email];
  if(!d.devices) d.devices = [];
  if(!d.devices.includes(navigator.userAgent)) d.devices.push(navigator.userAgent);

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("userBox").classList.remove("hidden");
  document.getElementById("namaUser").textContent = email.split("@")[0];
  document.getElementById("btnMulaiTes").disabled = false;

  if(!isAuto){
    localStorage.setItem("userData", JSON.stringify({email, password: pass}));
  }

  localStorage.setItem("verifikasiData", JSON.stringify(VERIFIKASI));
}

// ===== LOGOUT USER =====
document.getElementById("btnLogoutUser").onclick = () => {
  alert("üö´ Logout tidak diizinkan.");
};

// ===== ADMIN PANEL =====
document.getElementById("btnKirimEmail").onclick=()=> {
  const email = document.getElementById("email").value.trim().toLowerCase();
  if (!email) { alert("Isi email dulu"); return; }
  if (!VERIFIKASI[email]) VERIFIKASI[email] = {status:"Menunggu", password:"", verifiedAt:null, expireAt:null, devices:[]};
  localStorage.setItem("verifikasiData", JSON.stringify(VERIFIKASI));
  tampilAdmin();
  const waNumber = "6285736666655";
  const waMessage = encodeURIComponent(`Saya ingin meminta password untuk akun saya: ${email}`);
  if(confirm("Pesan WhatsApp resmi ke admin akan dibuka. Lanjutkan?")) window.open(`https://wa.me/${waNumber}?text=${waMessage}`, "_blank");
};

function tampilAdmin(){
  const tbody = document.getElementById("tabelAdminBody");
  tbody.innerHTML="";
  Object.keys(VERIFIKASI).forEach(email=>{
    const d = VERIFIKASI[email];
    const now = new Date();
    let sisa="-";
    if(d.expireAt){ 
      const exp=new Date(d.expireAt); 
      sisa=Math.floor((exp-now)/(1000*60*60*24)); 
      if(sisa<0){d.status="Expired"; sisa=0;} 
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${email}</td><td class="status ${d.status.toLowerCase()}">${d.status}</td>
      <td>${d.password||"-"}</td>
      <td>${d.devices?d.devices.length:0}</td>
      <td>${d.verifiedAt?new Date(d.verifiedAt).toLocaleDateString():"-"}</td>
      <td>${sisa}</td>
      <td>
        ${d.status!=="Disetujui"?`<button class="actionBtn" onclick="verifikasiUser('${email}')">Setujui</button>`:""}
        ${d.status==="Disetujui"||d.status==="Expired"?`<button class="actionBtn" onclick="batalVerifikasi('${email}')">Batalkan</button>`:""}
        <button class="actionBtn" onclick="aturPassword('${email}')">${d.password?'Ubah':'Buat'} Password</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function verifikasiUser(email){
  const now=new Date();
  VERIFIKASI[email].status="Disetujui";
  VERIFIKASI[email].verifiedAt=now.toISOString();
  VERIFIKASI[email].expireAt=new Date(now.getTime()+365*24*60*60*1000).toISOString();
  localStorage.setItem("verifikasiData", JSON.stringify(VERIFIKASI));
  tampilAdmin();
}
function batalVerifikasi(email){
  VERIFIKASI[email].status="Menunggu";
  VERIFIKASI[email].verifiedAt=null;
  VERIFIKASI[email].expireAt=null;
  localStorage.setItem("verifikasiData", JSON.stringify(VERIFIKASI));
  tampilAdmin();
}
function aturPassword(email){
  const pwd=prompt(`Masukkan password untuk ${email}:`,"");
  if(pwd){ VERIFIKASI[email].password=pwd; localStorage.setItem("verifikasiData", JSON.stringify(VERIFIKASI)); tampilAdmin(); }
}
document.getElementById("btnLogoutAdmin").onclick=()=> {
  document.getElementById("adminBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
};

// ===== TIMER =====
let timerInterval;
function mulaiTimer(min){
  const box=document.getElementById("timerBox"),txt=document.getElementById("timerText");
  if(document.getElementById("disableTimer").checked){box.style.display='none';return;}
  let waktu=min*60; box.style.display='block';
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    waktu--;
    const m=Math.floor(waktu/60); const s=(waktu%60).toString().padStart(2,'0');
    txt.textContent=`‚è± ${m}:${s}`;
    if(waktu<=0){clearInterval(timerInterval);alert("‚è∞ Waktu habis!");document.getElementById("btnKirimJawaban").click();}
  },1000);
}
function stopTimer(){clearInterval(timerInterval);document.getElementById("timerBox").style.display='none';}
function generatePDF(namaUser, pelajaran, hasilHTML, nomorAbsen) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // ===== INFO PDF =====
  doc.setFont("times", "normal"); 
  doc.setFontSize(16);
  doc.text("Hasil Ulangan", 105, 20, null, null, "center");
  doc.setFontSize(12);
  doc.text(`Nama: ${namaUser}`, 20, 30);
  doc.text(`Nomor Absen: ${nomorAbsen}`, 20, 38);
  doc.text(`Pelajaran: ${pelajaran}`, 20, 46);

  let yPos = 60;

  // ambil skor jika ada
  const skorEl = document.querySelector('.scoreBox');
  if(skorEl){
    doc.setFont("times", "bold");
    doc.setFontSize(14);
    doc.text(skorEl.textContent || "", 20, yPos);
    yPos += 10; // jarak
  }

  // ambil isi tes
  const cleanText = stripHTML(hasilHTML).split("\n"); // pecah baris
  doc.setFont("times", "normal");
  doc.setFontSize(12);
  cleanText.forEach(line => {
    if(yPos > 280){ // halaman penuh
      doc.addPage();
      yPos = 20;
    }
    doc.text(line, 20, yPos);
    yPos += 7; // jarak antar baris
  });

  doc.save(`${pelajaran}_${namaUser}.pdf`);
}

// Helper: hapus tag HTML dan karakter aneh
function stripHTML(html){
  const tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  return (tmp.textContent || tmp.innerText || "").replace(/[^\x00-\x7F]/g, ""); // hapus karakter non-ASCII
}

// Helper: hapus tag HTML
// Helper: hapus tag HTML dan karakter non-ASCII
function stripHTML(html){
  const tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  // hapus semua karakter non-ASCII agar √ò=√ú√ä tidak muncul
  return (tmp.textContent || tmp.innerText || "").replace(/[^\x00-\x7F]/g, "");
}


// ===== TES =====
document.getElementById("btnMulaiTes").onclick = () => {
  const pel = document.getElementById("subPelajaran").value;

  if(!SOAL[pel] || SOAL[pel].length===0){ 
    alert("Soal belum tersedia"); 
    return; 
  }

  // ===== Password khusus untuk ulangan =====
  const daftarUlangan = ["bahasa_indonesia_ulangan","matematika_ulangan"];
  if(daftarUlangan.includes(pel)){
    const pwd = prompt("Masukkan password untuk membuka soal ulangan:");
    const pwdBenar = "1234"; // ganti sesuai ketentuan admin
    if(!pwd || pwd !== pwdBenar){
      alert("‚ùå Password salah! Tes tidak bisa dimulai.");
      return; // hentikan eksekusi untuk ulangan
    }
  }

  document.getElementById("soalBox").classList.remove("hidden");
  document.getElementById("pilihPelajaranBox").classList.add("hidden");
  const cont = document.getElementById("soalContainer"); 
  cont.innerHTML="";
// Mulai timer
const durasi = parseInt(document.getElementById("timerInput").value) || 10;
mulaiTimer(durasi);


  const ringkasanBoxes = []; // simpan semua box ringkasan

  // ===== Tombol toggle ringkasan hanya untuk latihan, bukan ulangan =====
  if(!daftarUlangan.includes(pel)){
    const toggleBtn = document.createElement("button"); 
    toggleBtn.textContent = "üìñ Tampilkan Ringkasan Materi"; 
    toggleBtn.style.cssText = "margin-bottom:10px;padding:6px 10px;border-radius:6px;background:#000;color:#fff;border:none;cursor:pointer;"; 

    toggleBtn.onclick = () => {
      const show = ringkasanBoxes.some(b => b.style.display === 'none');
      ringkasanBoxes.forEach(b => b.style.display = show ? 'block' : 'none'); 
      toggleBtn.textContent = show ? "üìñ Sembunyikan Ringkasan Materi" : "üìñ Tampilkan Ringkasan Materi";
    };

    cont.appendChild(toggleBtn);
  }

  let wrapperIndex = 0;
  SOAL[pel].forEach((s,i)=>{
    // buat ringkasan
    const ring=document.createElement("div");
    ring.className='ringkasanBox';
    ring.innerHTML=`<b>${s.ringkasanMateri || ""}</b>`;
    ring.style.display='none'; 
    ringkasanBoxes.push(ring); 
    cont.appendChild(ring);

    // buat soal
    const soalP=document.createElement("p");
    soalP.textContent=`${i+1}. ${s.soal}`; 
    cont.appendChild(soalP);

    if(s.tipe==="benar-salah-multi"){
      s.pernyataan.forEach((p,j)=>{
        const wrapper=document.createElement("div");
        wrapper.className="benar-salah-wrapper";
        wrapper.style.marginBottom="6px";
        wrapper.textContent=`${j+1}. ${p.text} `;
        ["Benar","Salah"].forEach(val=>{
          const btn=document.createElement("button");
          btn.textContent=val;
          btn.onclick=()=>{
            wrapper.querySelectorAll("button").forEach(b=>b.classList.remove("selected"));
            btn.classList.add('selected');
            wrapper.dataset.user=val;
          };
          wrapper.appendChild(btn);
        });
        wrapper.dataset.globalIndex = wrapperIndex++;
        cont.appendChild(wrapper);
      });
    } else {
      const grid=document.createElement("div"); 
      grid.className='option-grid';
      s.opsi.forEach((o,j)=>{
        const opt=document.createElement("div");
        opt.className='option'; 
        opt.dataset.name=i; 
        opt.dataset.value=j;
        opt.textContent=`${String.fromCharCode(65+j)}. ${o}`;
        opt.onclick=()=>{ 
          cont.querySelectorAll(`.option[data-name='${i}']`).forEach(el=>el.classList.remove('selected')); 
          opt.classList.add('selected'); 
        };
        grid.appendChild(opt);
      });
      cont.appendChild(grid);
    }
  });

  // ===== Tombol kirim jawaban =====
  document.getElementById("btnKirimJawaban").onclick = () => {
  const pel = document.getElementById("subPelajaran").value;
  const cont = document.getElementById("soalContainer");
  let nilai = 0;
  const daftarUlangan = ["bahasa_indonesia_ulangan","matematika_ulangan"];
  const pembahasanList = []; // untuk ulangan atau latihan tersimpan dulu
  let globalWrapperIndex = 0;

  SOAL[pel].forEach((s,i) => {
    if(s.tipe === "benar-salah-multi"){
      s.pernyataan.forEach((p,j) => {
        const w = cont.querySelectorAll(".benar-salah-wrapper")[globalWrapperIndex++];
        const jawabanUser = w.dataset.user;
        const benar = jawabanUser === p.key;
        if(benar) nilai++;

        if(daftarUlangan.includes(pel)){
          // simpan jawaban & pembahasan tapi sembunyikan
          pembahasanList.push({
            qIndex:`${i+1}.${j+1}`,
            html:`<div class='pembahasan' style='display:none'>
                    <b>Jawaban benar:</b> ${p.key} <br>
                    <b>Pembahasan:</b> ${p.pembahasan || ''}</div>`
          });
          // disable pilihan supaya user tidak bisa mengubah
          w.querySelectorAll("button").forEach(btn => btn.disabled = true);
        } else {
          // latihan langsung tampilkan pembahasan
          pembahasanList.push(`<p><b>${i+1}.${j+1}.</b> ${p.text} <br>
                               <b>Jawaban benar:</b> ${p.key} <br>
                               <b>Pembahasan:</b> ${p.pembahasan || ''}</p>`);
        }
      });
    } else {
      // pilihan ganda
      const pilih = cont.querySelector(`.option[data-name='${i}'].selected`);
      const idx = pilih ? parseInt(pilih.dataset.value) : -1;
      if(idx === s.jawaban) nilai++;

      if(daftarUlangan.includes(pel)){
        pembahasanList.push({
          qIndex:`${i+1}`,
          html:`<div class='pembahasan' style='display:none'>
                  <b>Jawaban benar:</b> ${String.fromCharCode(65+s.jawaban)}. ${s.opsi[s.jawaban]}<br>
                  <b>Pembahasan:</b> ${s.pembahasan}</div>`
        });
        cont.querySelectorAll(`.option[data-name='${i}']`).forEach(opt => opt.onclick = null);
      } else {
        pembahasanList.push(`<p><b>${i+1}.</b> Jawaban benar: ${String.fromCharCode(65+s.jawaban)}. ${s.opsi[s.jawaban]}<br>
                             <b>Pembahasan:</b> ${s.pembahasan}</p>`);
      }
    }
  });

  // tampilkan skor
  const hasilTesEl = document.getElementById("hasilTes");
  hasilTesEl.innerHTML = `<div class='scoreBox'>üìä Nilai: ${Math.round(nilai / SOAL[pel].length * 100)}</div>`;
  hasilTesEl.classList.remove("hidden");
  stopTimer();
  document.getElementById("btnKirimJawaban").disabled = true;

  if(daftarUlangan.includes(pel)){
    // ===== Ulangan: tombol tampilkan pembahasan dengan password =====
    const pembahasanContainer = document.createElement("div");
    pembahasanContainer.id = "pembahasanContainer";
    pembahasanContainer.style.marginTop = "10px";
    hasilTesEl.appendChild(pembahasanContainer);

    const btnReveal = document.createElement("button");
    btnReveal.textContent = "üîí Tampilkan Pembahasan (Password)";
    btnReveal.style.cssText = "margin-top:10px;padding:6px 10px;border-radius:6px;background:#000;color:#fff;border:none;cursor:pointer;";
    btnReveal.onclick = () => {
      const revealPwd = "1234"; // password admin untuk ulangan
      const userPwd = prompt("Masukkan password untuk menampilkan pembahasan:");
      if(userPwd === revealPwd){
        pembahasanList.forEach(item => {
          const wrapper = document.createElement("div");
          wrapper.innerHTML = `<p style="font-weight:bold;margin-top:8px;">${item.qIndex}</p>` + item.html;
          const pembEl = wrapper.querySelector('.pembahasan');
          if(pembEl) pembEl.style.display='block';
          pembahasanContainer.appendChild(wrapper);
        });
        btnReveal.disabled = true;
        btnReveal.textContent = "üîì Pembahasan Ditampilkan";
        alert("‚úÖ Pembahasan berhasil ditampilkan.");
      } else alert("‚ùå Password salah. Pembahasan tidak ditampilkan.");
    };
    hasilTesEl.appendChild(btnReveal);

    // tombol cetak PDF
    const btnPDF = document.createElement("button");
    btnPDF.textContent = "üìÑ Cetak Hasil ke PDF";
    btnPDF.style.cssText = "margin-top:10px;padding:6px 10px;border-radius:6px;background:#0077b6;color:#fff;border:none;cursor:pointer;";
    btnPDF.onclick = () => {
  const namaUser = document.getElementById("namaUser").textContent;
  const nomorAbsen = document.getElementById("nomorAbsen").value || "-";
  generatePDF(namaUser, pel, hasilTesEl.innerHTML, nomorAbsen);
};

    hasilTesEl.appendChild(btnPDF);

  } else {
    // ===== Latihan biasa: tampilkan jawaban + pembahasan di bawah skor =====
    const pembahasanContainer = document.createElement("div");
    pembahasanContainer.style.marginTop = "10px";
    pembahasanContainer.innerHTML = pembahasanList.join("");
    hasilTesEl.appendChild(pembahasanContainer);
  }
};


};
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const btnKirimJawaban = document.getElementById("btnKirimJawaban");
  const soalBox = document.getElementById("soalBox");
  const hasilTes = document.getElementById("hasilTes");

  // üß© Cegah error saat elemen belum ada
  if (!btnKirimJawaban || !hasilTes) return;

  btnKirimJawaban.addEventListener("click", function() {
    // Pastikan tombol hanya berfungsi kalau soal terlihat
    if (soalBox.classList.contains("hidden")) {
      alert("Tes belum dimulai!");
      return;
    }

    // Contoh sederhana hasil otomatis (bisa disesuaikan)
    hasilTes.classList.remove("hidden");
    hasilTes.innerHTML = `
      <h3>‚úÖ Tes Selesai!</h3>
      <p>Terima kasih sudah mengerjakan ulangan.</p>
      <p>Jawaban Anda sedang diproses.</p>
    `;

    // Scroll ke hasil
    hasilTes.scrollIntoView({ behavior: "smooth" });
  });
});
</script>

</div>
</body>
</html>
